<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>My Cyprus Walk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.7.0/dist/aframe.min.js"></script>
  <!-- A-Frame Extras: movement-controls + touch-controls (–º–æ–±–∏–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.5.1/dist/aframe-extras.min.js"></script>

  <style>
    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∑–≤—É–∫–∞ ‚Äî –ª–µ–≤—ã–π –≤–µ—Ä—Ö */
    #start-audio{
      position:fixed; left:20px; top:20px; padding:10px 14px;
      border:0; border-radius:10px; background:#111; color:#fff;
      font:600 14px/1.2 system-ui; box-shadow:0 4px 16px rgba(0,0,0,.2);
      cursor:pointer; z-index:30
    }
    #start-audio.hidden{display:none}

    /* POP-UP 300√ó300 ‚Äî –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö */
    #popup{
      position:fixed; right:20px; top:20px; width:300px; height:300px;
      background:#000; border-radius:12px; overflow:hidden; display:none;
      z-index:25; box-shadow:0 12px 40px rgba(0,0,0,.35)
    }
    #popup video{width:100%; height:100%; object-fit:cover}

    /* HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –ª–µ–≤—ã–π –Ω–∏–∑ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ–∑–∂–µ) */
    #hud{
      position:fixed; left:10px; bottom:10px; background:rgba(0,0,0,.6);
      color:#fff; font:12px system-ui; padding:6px 8px; border-radius:8px;
      z-index:20; pointer-events:none
    }
  </style>
</head>
<body>
<a-scene
  loading-screen="dotsColor:#fff"
  device-orientation-permission-ui="enabled: true">

  <!-- –ê—Å—Å–µ—Ç—ã -->
  <a-assets>
    <a-asset-item id="street" src="assets/models/Limasol_Street%20(2).glb"></a-asset-item>
  </a-assets>

  <!-- –ù–µ–±–æ –æ–¥–Ω–∏–º —Ü–≤–µ—Ç–æ–º -->
  <a-sky color="#c8c8d6"></a-sky>

  <!-- –°–≤–µ—Ç -->
  <a-entity light="type: ambient; intensity: 0.35"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="2 4 2"></a-entity>

  <!-- RIG: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –¥–≤–∏–≥–∞–µ—Ç—Å—è; –≤–Ω—É—Ç—Ä–∏ ‚Äî –∫–∞–º–µ—Ä–∞.
       movement-controls –≤–∫–ª—é—á–∞–µ—Ç —Ö–æ–¥—å–±—É: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, –≥–µ–π–º–ø–∞–¥, –¢–ê–ß (–¥–∂–æ–π—Å—Ç–∏–∫ –Ω–∞ –º–æ–±–∏–ª–µ). -->
  <a-entity id="rig" movement-controls="speed: 0.15">
    <a-entity id="player"
              camera
              look-controls
              touch-controls
              position="0 1.6 0">
    </a-entity>
  </a-entity>

  <!-- –ú–æ–¥–µ–ª—å —É–ª–∏—Ü—ã -->
  <a-entity gltf-model="#street" position="0 0 0"></a-entity>

  <!-- –¢—Ä–∏–≥–≥–µ—Ä –ø–æ–ø-–∞–ø–∞ —É —Ç–≤–æ–µ–π —Ç–æ—á–∫–∏ -->
  <a-entity id="trigger1"
            position="6.088 1.600 1.772"
            proximity-popup="radius: 6; video: #clip1; duration: 8000">
  </a-entity>
</a-scene>

<!-- –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ -->
<audio id="amb"
       src="assets/audio/Analog_Mannequin%20Milk%20Cassette%20X.mp3%20-%20Demo.mp3"
       preload="auto" loop></audio>

<!-- –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ (—Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É) -->
<button id="start-audio">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

<!-- POP-UP 300√ó300 —Å –≤–∏–¥–µ–æ -->
<div id="popup">
  <video id="clip1"
         src="assets/video/clip1.mp4"
         preload="metadata"
         playsinline></video>
</div>

<!-- HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞–º–µ—Ä—ã -->
<div id="hud">x:0 y:0 z:0</div>

<script>
/* ---------- –ó–≤—É–∫: —Å–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∂–µ—Å—Ç–∞ ---------- */
let soundUnlocked = false;
const btn = document.getElementById('start-audio');
const amb = document.getElementById('amb');
function startAudio() {
  amb.play().then(()=>{
    soundUnlocked = true;
    btn.classList.add('hidden');
  }).catch(()=>{});
  window.removeEventListener('click', startAudio);
  window.removeEventListener('touchstart', startAudio);
}
btn.addEventListener('click', startAudio);
window.addEventListener('click', startAudio);
window.addEventListener('touchstart', startAudio);

/* ---------- HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ---------- */
const hud = document.getElementById('hud');
const camEl = document.querySelector('#player');
function fmt(n){return Number(n).toFixed(3)}
setInterval(()=>{
  if (!camEl.object3D) return;
  const p = camEl.object3D.getWorldPosition(new THREE.Vector3());
  hud.textContent = `x:${fmt(p.x)}  y:${fmt(p.y)}  z:${fmt(p.z)}`;
}, 200);

/* ---------- –ü–æ–ø-–∞–ø –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏ ---------- */
AFRAME.registerComponent('proximity-popup',{
  schema:{
    radius:{type:'number', default:6},
    video:{type:'selector'},
    duration:{type:'number', default:8000}
  },
  init(){
    this._shown = false;
    this._popup = document.getElementById('popup');
    this._video = this.data.video || document.getElementById('clip1');
  },
  tick(){
    if(this._shown) return;
    const rig = document.querySelector('#rig').object3D.getWorldPosition(new THREE.Vector3());
    const p = this.el.object3D.getWorldPosition(new THREE.Vector3());
    const dist = rig.distanceTo(p);
    if(dist <= this.data.radius){ this.show(); }
  },
  show(){
    this._shown = true;
    this._popup.style.display = 'block';
    this._video.muted = !soundUnlocked;
    this._video.currentTime = 0;
    this._video.play().catch(()=>{});
    setTimeout(()=>{
      this._video.pause();
      this._popup.style.display = 'none';
      // this._shown = false; // —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
    }, this.data.duration);
  }
});
</script>
</body>
</html>
