<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>My Cyprus Walk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.7.0/dist/aframe.min.js"></script>
  <!-- A-Frame Extras: movement-controls + touch-controls (–º–æ–±–∏–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.5.1/dist/aframe-extras.min.js"></script>
  <style>
    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∑–≤—É–∫–∞ ‚Äî –ª–µ–≤—ã–π –≤–µ—Ä—Ö */
    #start-audio{
      position:fixed; left:20px; top:20px; padding:10px 14px;
      border:0; border-radius:10px; background:#111; color:#fff;
      font:600 14px/1.2 system-ui; box-shadow:0 4px 16px rgba(0,0,0,.2);
      cursor:pointer; z-index:30
    }
    #start-audio.hidden{display:none}
    /* HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –ª–µ–≤—ã–π –Ω–∏–∑ (–¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞; –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ–∑–∂–µ) */
    #hud{
      position:fixed; left:10px; bottom:10px; background:rgba(0,0,0,.6);
      color:#fff; font:12px system-ui; padding:6px 8px; border-radius:8px;
      z-index:20; pointer-events:none
    }
  </style>
</head>
<body>
<a-scene loading-screen="dotsColor:#fff"
         device-orientation-permission-ui="enabled: true">

  <!-- –ê—Å—Å–µ—Ç—ã -->
  <a-assets>
    <!-- –º–æ–¥–µ–ª—å -->
    <a-asset-item id="street" src="assets/models/Limasol_Street%20(2).glb"></a-asset-item>
    <!-- –≤–∏–¥–µ–æ -->
    <video id="clip1" src="assets/video/clip1.mp4" preload="metadata" playsinline></video>
  </a-assets>

  <!-- –ù–µ–±–æ -->
  <a-sky color="#c8c8d6"></a-sky>

  <!-- –°–≤–µ—Ç -->
  <a-entity light="type: ambient; intensity: 0.35"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="2 4 2"></a-entity>

  <!-- RIG (–¥–≤–∏–∂–µ–Ω–∏–µ) + –∫–∞–º–µ—Ä–∞ -->
  <a-entity id="rig" movement-controls="speed: 0.15">
    <a-entity id="player" camera look-controls touch-controls position="0 1.6 0"></a-entity>
  </a-entity>

  <!-- –£–ª–∏—Ü–∞ -->
  <a-entity gltf-model="#street" position="0 0 0"></a-entity>

  <!-- –¢—Ä–∏–≥–≥–µ—Ä –≤ –º–∏—Ä–µ (—Ç–æ—á–∫–∞, —Ä—è–¥–æ–º —Å –∫–æ—Ç–æ—Ä–æ–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç) -->
  <a-entity id="trigger1"
            position="6.088 0.0 1.772"
            proximity-video-panel="
              radius: 0.5;
              panel: #videoBoard;
              video: #clip1;
              forward: 1.2;
              right: 0.35;
              loops: 3;
              cooldownMs: 400;
              hysteresis: 0.2">
  </a-entity>

  <!-- –°–∞–º–∞ ¬´—Ç–∞–±–ª–∏—á–∫–∞¬ª 0.9√ó0.9 –º. –ï—ë –ø–æ–∑–∏—Ü–∏—è/–ø–æ–≤–æ—Ä–æ—Ç –∑–∞–¥–∞—ë–º –≤ –∫–æ–¥–µ –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ -->
  <a-plane id="videoBoard"
           visible="false"
           width="0.9" height="0.9"
           material="src: #clip1; shader: flat; side: double">
  </a-plane>
</a-scene>

<!-- –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ -->
<audio id="amb"
       src="assets/audio/Analog_Mannequin%20Milk%20Cassette%20X.mp3%20-%20Demo.mp3"
       preload="auto" loop></audio>

<!-- –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ -->
<button id="start-audio">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

<!-- HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞–º–µ—Ä—ã -->
<div id="hud">x:0 y:0 z:0</div>

<script>
/* ---------- –ó–≤—É–∫: —Å–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∂–µ—Å—Ç–∞ ---------- */
let soundUnlocked = false;
const btn = document.getElementById('start-audio');
const amb = document.getElementById('amb');
function startAudio() {
  amb.play().then(()=>{ soundUnlocked = true; btn.classList.add('hidden'); }).catch(()=>{});
  window.removeEventListener('click', startAudio);
  window.removeEventListener('touchstart', startAudio);
}
btn.addEventListener('click', startAudio);
window.addEventListener('click', startAudio);
window.addEventListener('touchstart', startAudio);

/* ---------- HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ---------- */
const hud = document.getElementById('hud');
const camEl = document.querySelector('#player');
function fmt(n){return Number(n).toFixed(3)}
setInterval(()=>{
  if (!camEl.object3D) return;
  const p = camEl.object3D.getWorldPosition(new THREE.Vector3());
  hud.textContent = `x:${fmt(p.x)}  y:${fmt(p.y)}  z:${fmt(p.z)}`;
}, 200);

/* ---------- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: –ø–∞–Ω–µ–ª—å-–≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ –∑—Ä–∏—Ç–µ–ª–µ–º ---------- */
AFRAME.registerComponent('proximity-video-panel',{
  schema:{
    radius:{type:'number', default:0.5},      // —Ä–∞–¥–∏—É—Å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (–º)
    panel:{type:'selector'},                  // <a-plane> –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤–∏–¥–µ–æ
    video:{type:'selector'},                  // <video>
    forward:{type:'number', default:1.2},     // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–ø–µ—Ä—ë–¥ –æ—Ç –∏–≥—Ä–æ–∫–∞ (–º)
    right:{type:'number', default:0.35},      // —Å–¥–≤–∏–≥ –≤–ø—Ä–∞–≤–æ (–º)
    loops:{type:'number', default:3},         // —Ä–∞–∑ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
    cooldownMs:{type:'number', default:400},  // –∑–∞—â–∏—Ç–∞ –æ—Ç ¬´–¥—Ä–µ–±–µ–∑–≥–∞¬ª
    hysteresis:{type:'number', default:0.2}   // –Ω–∞ —Å–∫–æ–ª—å–∫–æ –¥–∞–ª—å—à–µ –Ω—É–∂–Ω–æ —É–π—Ç–∏, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤—Ç–æ—Ä
  },
  init(){
    this.active = false;     // —Å–µ–π—á–∞—Å –∏–¥—ë—Ç –ø–æ–∫–∞–∑
    this.waitExit = false;   // –∂–¥—ë–º –≤—ã—Ö–æ–¥–∞ –∑–∞ —Ä–∞–¥–∏—É—Å
    this.cooling = false;    // –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ–∫–∞–¥—Ä–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç
    this.looped = 0;

    this.panelEl = this.data.panel || document.querySelector('#videoBoard');
    this.videoEl = this.data.video  || document.querySelector('#clip1');

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–Ω—Ü–∞ —Ä–æ–ª–∏–∫–∞
    this._onEnded = () => {
      this.looped++;
      if (this.looped < this.data.loops) {
        this.videoEl.currentTime = 0;
        this.videoEl.play().catch(()=>{});
      } else {
        this.hidePanel();
        this.waitExit = true; // –∂–¥—ë–º –≤—ã—Ö–æ–¥–∞ –∑–∞ —Ä–∞–¥–∏—É—Å + –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å
      }
    };
  },
  tick(){
    const rig = document.querySelector('#rig').object3D.getWorldPosition(new THREE.Vector3());
    const trig = this.el.object3D.getWorldPosition(new THREE.Vector3());
    const dist = rig.distanceTo(trig);

    // —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞
    if (this.waitExit && dist > (this.data.radius + this.data.hysteresis)) {
      this.waitExit = false;
    }

    if (this.active || this.waitExit || this.cooling) return;

    if (dist <= this.data.radius) {
      this.showPanel(rig);
    }
  },
  showPanel(rigPos){
    this.active = true;
    this.looped = 0;

    // –ø–æ–∑–∏—Ü–∏—è –∏ –ø–æ–≤–æ—Ä–æ—Ç –ø–∞–Ω–µ–ª–∏: –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–∫–æ–º, —á—É—Ç—å –≤–ø—Ä–∞–≤–æ, –Ω–∞ –≤—ã—Å–æ—Ç–µ –≥–ª–∞–∑
    const cam = document.querySelector('#player').object3D;
    const camPos = cam.getWorldPosition(new THREE.Vector3());
    const dir = new THREE.Vector3();
    cam.getWorldDirection(dir);                 // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
    const forward = new THREE.Vector3(dir.x, 0, dir.z).normalize(); // —Ç–æ–ª—å–∫–æ –ø–æ XZ
    if (forward.lengthSq() < 1e-6) forward.set(0,0,-1);
    const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

    const pos = new THREE.Vector3()
      .copy(camPos)
      .add(forward.multiplyScalar(this.data.forward))
      .add(right.multiplyScalar(this.data.right));

    // –≤—ã—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏ ¬´—Å–º–æ—Ç—Ä–∏–º¬ª –Ω–∞ –∏–≥—Ä–æ–∫–∞ –ø–æ Y (–±–µ–∑ –Ω–∞–∫–ª–æ–Ω–æ–≤)
    this.panelEl.object3D.position.copy(pos);
    const lookTarget = new THREE.Vector3(camPos.x, pos.y, camPos.z); // —Ç–æ—Ç –∂–µ Y ‚Üí —Ç–æ–ª—å–∫–æ –ø–æ–≤–æ—Ä–æ—Ç –ø–æ Y
    this.panelEl.object3D.lookAt(lookTarget);
    this.panelEl.setAttribute('visible', true);

    // –≤–∏–¥–µ–æ
    this.videoEl.muted = !soundUnlocked;
    this.videoEl.currentTime = 0;
    this.videoEl.loop = false;
    this.videoEl.removeEventListener('ended', this._onEnded);
    this.videoEl.addEventListener('ended', this._onEnded);
    this.videoEl.play().catch(()=>{});
  },
  hidePanel(){
    this.videoEl.pause();
    this.panelEl.setAttribute('visible', false);
    this.active = false;

    // –∫–æ—Ä–æ—Ç–∫–∏–π ¬´–∞–Ω—Ç–∏-–¥—Ä–µ–±–µ–∑–≥¬ª, —á—Ç–æ–±—ã –Ω–µ —Å—Ö–≤–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä —Ç—É—Ç –∂–µ
    this.cooling = true;
    setTimeout(()=>{ this.cooling = false; }, this.data.cooldownMs);
  }
});
</script>
</body>
</html>
