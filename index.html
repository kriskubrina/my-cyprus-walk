<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>My Cyprus Walk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.7.0/dist/aframe.min.js"></script>
  <!-- A-Frame Extras: movement-controls + touch-controls (–º–æ–±–∏–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.5.1/dist/aframe-extras.min.js"></script>
  <style>
    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∑–≤—É–∫–∞ ‚Äî –ª–µ–≤—ã–π –≤–µ—Ä—Ö */
    #start-audio{
      position:fixed; left:20px; top:20px; padding:10px 14px;
      border:0; border-radius:10px; background:#111; color:#fff;
      font:600 14px/1.2 system-ui; box-shadow:0 4px 16px rgba(0,0,0,.2);
      cursor:pointer; z-index:30
    }
    #start-audio.hidden{display:none}

    /* HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –ª–µ–≤—ã–π –Ω–∏–∑ (–¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞; –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ–∑–∂–µ) */
    #hud{
      position:fixed; left:10px; bottom:10px; background:rgba(0,0,0,.6);
      color:#fff; font:12px system-ui; padding:6px 8px; border-radius:8px;
      z-index:20; pointer-events:none
    }
  </style>
</head>
<body>
<a-scene loading-screen="dotsColor:#fff"
         device-orientation-permission-ui="enabled: true">

  <!-- –ê—Å—Å–µ—Ç—ã -->
  <a-assets>
    <!-- –º–æ–¥–µ–ª—å -->
    <a-asset-item id="street" src="assets/models/Limasol_Street%20(2).glb"></a-asset-item>
    <!-- –≤–∏–¥–µ–æ –¥–ª—è —Ç–∞–±–ª–∏—á–∫–∏ -->
    <video id="clip1" src="assets/video/clip1.mp4"
           preload="metadata" playsinline></video>
  </a-assets>

  <!-- –ù–µ–±–æ -->
  <a-sky color="#c8c8d6"></a-sky>

  <!-- –°–≤–µ—Ç -->
  <a-entity light="type: ambient; intensity: 0.35"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="2 4 2"></a-entity>

  <!-- RIG (–¥–≤–∏–∂–µ–Ω–∏–µ) + –∫–∞–º–µ—Ä–∞ -->
  <a-entity id="rig" movement-controls="speed: 0.15">
    <a-entity id="player" camera look-controls touch-controls position="0 1.6 0"></a-entity>
  </a-entity>

  <!-- –£–ª–∏—Ü–∞ -->
  <a-entity gltf-model="#street" position="0 0 0"></a-entity>

  <!-- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ –∑–µ–º–ª–µ + —Ç–∞–±–ª–∏—á–∫–∞ 3D (–∫–∞–∫ –ø–ª–∞–∫–∞—Ç) -->
  <a-entity id="trigger1"
            position="6.088 0.0 1.772"
            proximity-video="radius: 0.5; board: #videoBoard; video: #clip1; duration: 8000">
    <!-- –¢–∞–±–ª–∏—á–∫–∞: 0.9√ó0.9 –º, —Å—Ç–æ–∏—Ç –Ω–∞ –∑–µ–º–ª–µ; –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞ -->
    <a-plane id="videoBoard"
             visible="false"
             position="0 0.45 0"
             width="0.9" height="0.9"
             material="src: #clip1; shader: flat; side: double">
    </a-plane>
  </a-entity>
</a-scene>

<!-- –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ -->
<audio id="amb"
       src="assets/audio/Analog_Mannequin%20Milk%20Cassette%20X.mp3%20-%20Demo.mp3"
       preload="auto" loop></audio>

<!-- –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ -->
<button id="start-audio">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

<!-- HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞–º–µ—Ä—ã -->
<div id="hud">x:0 y:0 z:0</div>

<script>
/* ---------- –ó–≤—É–∫: —Å–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∂–µ—Å—Ç–∞ ---------- */
let soundUnlocked = false;
const btn = document.getElementById('start-audio');
const amb = document.getElementById('amb');
function startAudio() {
  amb.play().then(()=>{ soundUnlocked = true; btn.classList.add('hidden'); }).catch(()=>{});
  window.removeEventListener('click', startAudio);
  window.removeEventListener('touchstart', startAudio);
}
btn.addEventListener('click', startAudio);
window.addEventListener('click', startAudio);
window.addEventListener('touchstart', startAudio);

/* ---------- HUD –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ---------- */
const hud = document.getElementById('hud');
const camEl = document.querySelector('#player');
function fmt(n){return Number(n).toFixed(3)}
setInterval(()=>{
  if (!camEl.object3D) return;
  const p = camEl.object3D.getWorldPosition(new THREE.Vector3());
  hud.textContent = `x:${fmt(p.x)}  y:${fmt(p.y)}  z:${fmt(p.z)}`;
}, 200);

/* ---------- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: 3D —Ç–∞–±–ª–∏—á–∫–∞-–≤–∏–¥–µ–æ –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏ ---------- */
AFRAME.registerComponent('proximity-video',{
  schema:{
    radius:{type:'number', default:0.5},      // —Ä–∞–¥–∏—É—Å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (–º)
    board:{type:'selector'},                  // <a-plane> —Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–º –≤–∏–¥–µ–æ
    video:{type:'selector'},                  // <video> —ç–ª–µ–º–µ–Ω—Ç
    duration:{type:'number', default:8000}    // –º—Å –ø–æ–∫–∞–∑–∞
  },
  init(){
    this.inside = false;       // –∏–≥—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–¥–∏—É—Å–∞
    this.waitExit = false;     // –∂–¥—ë–º, –ø–æ–∫–∞ –≤—ã–π–¥–µ—Ç, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
    this.board = this.data.board || document.querySelector('#videoBoard');
    this.video = this.data.video || document.querySelector('#clip1');
  },
  tick(){
    const rigPos = document.querySelector('#rig').object3D.getWorldPosition(new THREE.Vector3());
    const trigPos = this.el.object3D.getWorldPosition(new THREE.Vector3());
    const dist = rigPos.distanceTo(trigPos);

    if (!this.inside && !this.waitExit && dist <= this.data.radius) {
      this.show(rigPos, trigPos);
    }
    // –µ—Å–ª–∏ –ø–æ–∫–∞–∑–∞–ª–∏ –∏ –∂–¥—ë–º –≤—ã—Ö–æ–¥–∞ ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∑–∞ —Ä–∞–¥–∏—É—Å
    if (this.waitExit && dist > this.data.radius){
      this.waitExit = false;
      this.inside = false;
    }
  },
  show(rigPos, trigPos){
    this.inside = true;

    // –ü–æ–≤–µ—Ä–Ω—É—Ç—å —Ç–∞–±–ª–∏—á–∫—É –ª–∏—Ü–æ–º –∫ –∏–≥—Ä–æ–∫—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å
    const boardEl = this.board;
    boardEl.object3D.lookAt(rigPos);
    boardEl.setAttribute('visible', true);

    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–µ–æ (–∑–≤—É–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–≤—É–∫ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
    this.video.muted = !soundUnlocked;
    this.video.currentTime = 0;
    this.video.play().catch(()=>{});

    // –°–ø—Ä—è—Ç–∞—Ç—å —á–µ—Ä–µ–∑ duration –∏ –∂–¥–∞—Ç—å –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ä–∞–¥–∏—É—Å–∞
    setTimeout(()=>{
      this.video.pause();
      boardEl.setAttribute('visible', false);
      this.waitExit = true;    // —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –ø–æ–∫–∞ —Å—Ç–æ–∏–º –Ω–∞ –º–µ—Å—Ç–µ
    }, this.data.duration);
  }
});
</script>
</body>
</html>
